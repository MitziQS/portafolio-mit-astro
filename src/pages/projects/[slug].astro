---
// src/pages/proyectos/[slug].astro
import { getCollection, type CollectionEntry } from 'astro:content'
import Button from '../../components/Button.astro'
import Layout from '../../layouts/Layout.astro'

export async function getStaticPaths() {
  const projects = await getCollection('projects')
  return projects.map((p) => ({
    params: { slug: p.slug },
    props: { project: p }
  }))
}

type Props = { project: CollectionEntry<'projects'> }
const { project } = Astro.props as Props
const { Content } = await project.render()

const perProjectNav: Record<string, { label: string; href: string }[]> = {
  'proyecto-1': [
    { label: 'Inicio', href: '#top' },
    { label: 'Investigación', href: '#investigacion' },
    { label: 'Definición', href: '#definicion' },
    { label: 'Diseño', href: '#diseno' },
    { label: 'Pruebas', href: '#pruebas' },
    { label: 'Entrega', href: '#entrega' }
  ],
  'proyecto-2': [
    { label: 'Inicio', href: '#top' },
    { label: 'Investigación', href: '#investigacion' },
    { label: 'Definición', href: '#definicion' },
    { label: 'Ideación', href: '#ideacion' },
    { label: 'Diseño', href: '#diseno' },
    { label: 'Entrega', href: '#entrega' }
  ],
  'proyecto-3': [
    { label: 'Inicio', href: '#top' },
    { label: 'Investigación', href: '#investigacion' },
    { label: 'Definición', href: '#definicion' },
    { label: 'Diseño', href: '#diseno' },
    { label: 'Entrega', href: '#entrega' }
  ]
}

const navItems = perProjectNav[project.slug]

const options = {
  title: project.data.title,
  description: project.data.summary || '',
  navItems
}
---

<Layout options={options}>
  <section class="projects section">
    <div class="project-wrapper">
      <div id="top"></div>

      <!-- ✅ BOTÓN REGRESAR -->
      <Button
        href={`${import.meta.env.BASE_URL}#proyectos`}
        class="small back-link"
        onclick="if (history.length > 1) { history.back(); return false; }"
      >
        ← Regresar
      </Button>

      <!-- ✅ TÍTULO -->
      <header class="project-hero">
        <h1 class="project-title">{project.data.title}</h1>
      </header>

      <!-- ✅ HERO IMG -->
      {
        project.data.cover && (
          <figure class="project-media">
            <img
              src={project.data.cover}
              alt={project.data.coverAlt ?? project.data.title}
              loading="eager"
            />
          </figure>
        )
      }

      <!-- ✅ CONTENIDO -->
      <article class="project-content">
        <Content />
      </article>
    </div>
  </section>

  <style is:global>
    /* ===== WRAPPER ===== */
    .project-wrapper {
      max-width: 1054px;
      margin-inline: auto;
      padding-inline: var(--mobile-inline-padding);
      padding-block: var(--section-y);
    }

    /* ===== HERO ===== */
    .project-hero {
      margin: 0.25rem 0 1rem;
    }
    .project-title {
      margin: 0.5rem 0 1.5rem; /* solo spacing */
    }

    /* ===== IMAGEN ===== */
    .project-media {
      margin: 0 0 2rem;
    }
    .project-media img,
    .hero-media {
      width: 100%;
      height: auto;
      border-radius: 12px;
      display: block;
      margin-bottom: 2rem;
    }

    /* ===== ESPACIADOS GENERALES ===== */
    .project-content :is(h2, h3, h4) {
      margin-top: 2rem;
      margin-bottom: 0.6rem;
    }
    .project-content > * + * {
      margin-top: 1rem;
    }

    /* ===== LISTAS ===== */
    .project-content .bulleted {
      padding-left: 18px;
      display: grid;
      gap: 0.4rem;
    }

    /* ===== APLICAR COLOR GLOBAL (gris) A TEXTO DE LECTURA ===== */
    .project-content p,
    .project-content li {
      color: var(--text-description-color);
    }

    /* ===== CARDS ===== */
    .project-content .card {
      background: var(--bg-secondary-color);
      border: 1px solid color-mix(in oklab, var(--text-color) 15%, transparent);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06);
    }

    .project-content > .card {
      margin-top: 32px;
    }

    /* ===== GRIDS ===== */
    .project-content .stack {
      display: grid;
      gap: 24px;
    }
    .project-content .grid-2 {
      display: grid;
      gap: 24px;
      grid-template-columns: 1.6fr 1fr;
    }
    .project-content .grid-3 {
      display: grid;
      gap: 24px;
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 900px) {
      .project-content .grid-2,
      .project-content .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    /* ===== KPI ===== */
    .project-content .kpi-grid {
      display: grid;
      gap: 24px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      margin-top: 0.5rem;
    }
    .project-content .kpi {
      background: transparent;
      border-radius: 14px;
      padding: 16px;
      border: 1px dashed color-mix(in oklab, var(--text-color) 18%, transparent);
    }
    .project-content .kpi__value {
      font-weight: 800;
      line-height: 1;
    }
    .project-content .kpi__label {
      opacity: 0.8;
    }

    /* ===== STEP ===== */
    .project-content .step {
      margin: 28px 0;
    }
    .project-content .step__eyebrow {
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.7;
      margin-bottom: 6px;
    }

    /* ===== IMÁGENES EN BODY ===== */
    .project-content .media {
      margin: 16px 0;
    }
    .project-content .media img {
      width: 100%;
      height: auto;
      border-radius: 12px;
    }

    /* ===== BACK LINK ===== */
    .project-wrapper .back-link {
      margin-bottom: 2rem;
    }

    /* ===== ANCLAS ===== */
    html {
      scroll-behavior: smooth;
    }
    [id] {
      scroll-margin-top: 96px;
    }
    @media (width >= 768px) {
      [id] {
        scroll-margin-top: 120px;
      }
    }

    /* ===== H2 CON LÍNEA ===== */
    .project-content h2.section-title {
      display: flex;
      align-items: center;
      gap: 24px;
      margin: 2.5rem 0 1rem;
    }
    .project-content h2.section-title::after {
      content: '';
      flex: 1 1 auto;
      height: 2px;
      background: color-mix(in oklab, var(--text-color) 35%, transparent);
      border-radius: 2px;
      translate: 0 0.2em;
    }
    @media (max-width: 768px) {
      .project-content h2.section-title::after {
        height: 1.5px;
      }
    }

    /* ATENCIÓN MIT, ESTO SE PUEDE BORRAR -Limita la medida de lectura SOLO en secciones del proceso */
    .project-content .step :where(p, ul, ol, blockquote, .card) {
      max-width: 92ch; /* ~45–75 caracteres por línea → legibilidad ideal */
      margin-right: auto; /* columna alineada a la izquierda */
    }

    /* Listas con buena separación y misma medida */
    .project-content .step .bulleted {
      max-width: 92ch;
    }

    /* Mantén imágenes/tablas a ancho completo (si quieres) */
    .project-content .step .media,
    .project-content .step .grid-3,
    .project-content .step .grid-2 {
      max-width: none;
    }

    /* En móviles deja que fluya al 100% */
    @media (max-width: 768px) {
      .project-content .step :where(p, ul, ol, blockquote, .card, .bulleted) {
        max-width: 100%;
      }
    }
  </style>
</Layout>
